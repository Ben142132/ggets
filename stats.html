<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Live H√ºhnerrennen-Statistik</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f0f4f8;
        }
        .container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }
        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 2px solid #d1d8e0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 12px;
            border: 1px solid #e8e8e8;
            text-align: left;
            color: #333;
        }
        th {
            background: #f8f9fa;
        }
        .winner-banner {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid;
            color: #333;
        }
        #refreshButton {
            background: #2196F3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            margin-top: 15px;
            cursor: pointer;
        }
        .hausgewinn-info {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .winner-details table {
            width: 100%;
            margin-top: 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            overflow: hidden;
        }
        .winner-details td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            color: #333;
        }
        .winner-details tr:last-child td {
            border-bottom: none;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBFgrVFSztNcvGdQnXidIEZ3ZAQrH33JC4",
            authDomain: "ggbets-43e25.firebaseapp.com",
            projectId: "ggbets-43e25",
            storageBucket: "ggbets-43e25.firebasestorage.app",
            messagingSenderId: "670788094252",
            appId: "1:670788094252:web:0b0ad8a20c3c115bc20489"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentData = {
            chickens: null,
            hausgewinn: 15,
            lastWinner: null
        };

        function loadData() {
            const docRef = doc(db, "rennen", "daten");
            
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    currentData = {
                        chickens: data.chickens,
                        hausgewinn: data.hausgewinn || 15,
                        lastWinner: JSON.parse(localStorage.getItem('lastWinner'))
                    };
                    updateUI();
                }
            });
        }

        function updateUI() {
            // Update Hausgewinn
            document.getElementById('currentHausgewinn').textContent = currentData.hausgewinn;

            // Update Quoten
            updateOddsTable();

            // Update Wetten
            updateBetsTable();

            // Update Gewinner
            showLastWinner();

            // Update Zeitstempel
            document.getElementById('updateTime').textContent = new Date().toLocaleTimeString();
        }

        function updateOddsTable() {
            const oddsTable = document.getElementById('oddsTable');
            if (!currentData.chickens) {
                oddsTable.innerHTML = '<tr><td colspan="3">Keine aktiven Wetten</td></tr>';
                return;
            }

            const totalPool = Object.values(currentData.chickens).reduce((sum, c) => sum + (c.total || 0), 0);
            const houseCut = totalPool * (currentData.hausgewinn / 100);
            const payoutPool = totalPool - houseCut;

            oddsTable.innerHTML = `
                <tr><th>Huhn</th><th>Eins√§tze</th><th>Quote</th></tr>
                ${Object.keys(currentData.chickens).map(id => `
                    <tr>
                        <td>${currentData.chickens[id]?.name || 'Unbekannt'}</td>
                        <td>${(currentData.chickens[id]?.total || 0).toFixed(2)}‚Ç¨</td>
                        <td>${currentData.chickens[id]?.total > 0 
                            ? (payoutPool / currentData.chickens[id].total).toFixed(2) + '‚Ç¨'
                            : '-'}
                        </td>
                    </tr>
                `).join('')}
            `;
        }

        function updateBetsTable() {
            const allBets = document.getElementById('allBets');
            if (!currentData.chickens) {
                allBets.innerHTML = '<tr><td colspan="4">Keine gespeicherten Wetten</td></tr>';
                return;
            }

            allBets.innerHTML = `
                <tr><th>Spieler</th><th>Huhn</th><th>Einsatz</th><th>Zeit</th></tr>
                ${Object.keys(currentData.chickens).map(id => 
                    (currentData.chickens[id]?.bets || []).map(bet => `
                        <tr>
                            <td>${bet.player || 'Unbekannt'}</td>
                            <td>${currentData.chickens[id]?.name || 'Unbekannt'}</td>
                            <td>${(bet.amount || 0).toFixed(2)}‚Ç¨</td>
                            <td>${bet.timestamp ? new Date(bet.timestamp).toLocaleTimeString() : '-'}</td>
                        </tr>
                    `).join('')
                ).join('')}
            `;
        }

        function showLastWinner() {
            const banner = document.getElementById('lastWinner');
            const winnerData = currentData.lastWinner;

            if (!winnerData) {
                banner.innerHTML = "üèÅ Noch kein Rennen beendet";
                banner.style.background = "#f0f0f0";
                banner.style.borderColor = "#ccc";
                return;
            }

            try {
                banner.innerHTML = `
                    <h3 style="margin:0; color: #333;">üèÜ ${winnerData.name} (${winnerData.time})</h3>
                    ${winnerData.bets?.length > 0 ? `
                    <div class="winner-details">
                        <p style="margin:10px 0 5px 0; color: #333;">üèÖ Gewinner:</p>
                        <table>
                            ${winnerData.bets.map(bet => `
                                <tr>
                                    <td>${bet.player || 'Unbekannt'}</td>
                                    <td>${(bet.amount * winnerData.payoutRate).toFixed(2)}‚Ç¨</td>
                                    <td style="color: #666;">(${(bet.amount || 0).toFixed(2)}‚Ç¨ Einsatz)</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                    ` : '<p style="margin-top:10px; color: #333;">Keine Gewinnerwetten</p>'}
                `;
                banner.style.borderColor = winnerData.color || '#48bb78';
                banner.style.background = "rgba(255,255,255,0.9)";
            } catch (e) {
                console.error('Fehler bei der Gewinneranzeige:', e);
                banner.innerHTML = "‚ö†Ô∏è Fehler beim Laden der Gewinnerdaten";
                banner.style.background = "#ffe0e0";
            }
        }

        // Initialisierung
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setInterval(() => {
                document.getElementById('updateTime').textContent = new Date().toLocaleTimeString();
            }, 1000);
        });
    </script>
</head>
<body>
    <h1>üêì Live H√ºhnerrennen</h1>
    
    <div id="lastWinner" class="winner-banner">
        üèÜ Letzter Sieger: Wird geladen...
    </div>

    <div class="hausgewinn-info">
        üè¶ Aktueller Hausgewinn: <span id="currentHausgewinn">15</span>%
    </div>

    <div class="container">
        <div class="section">
            <h2>üìà Aktuelle Quoten</h2>
            <div id="poolStatus">
                Letzte Aktualisierung: <span id="updateTime">-</span>
            </div>
            <table id="oddsTable">
                <tr><th>Huhn</th><th>Eins√§tze</th><th>Quote</th></tr>
            </table>
        </div>

        <div class="section">
            <h2>üìã Alle Wetten</h2>
            <table id="allBets">
                <tr><th>Spieler</th><th>Huhn</th><th>Einsatz</th><th>Zeit</th></tr>
            </table>
            <button id="refreshButton" onclick="loadData()">‚ü≥ Aktualisieren</button>
        </div>
    </div>
</body>
</html>
